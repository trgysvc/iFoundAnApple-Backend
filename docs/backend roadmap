iFoundAnApple Backend - GeliÅŸtirilmiÅŸ Yol HaritasÄ± (Cursor AI iÃ§in Notlarla)
Hedef Domain: api.ifoundanapple.comTeknoloji: Node.js + NestJSVersiyon: 1.0.0OluÅŸturulma Tarihi: 2025-11-06 (Revize: 2025-11-10)
ğŸ¯ Projenin Ana Hedefi ve GÃ¼venlik Felsefesi
Bu backend'in varoluÅŸ amacÄ±, iFoundAnApple platformunun gÃ¼venlik ve gÃ¼venilirlik merkezini oluÅŸturmaktÄ±r. Frontend (React uygulamasÄ±) kullanÄ±cÄ± arayÃ¼zÃ¼ ve Supabase ile doÄŸrudan veri okuma/yazma iÅŸlemlerini yÃ¶netirken, backend aÅŸaÄŸÄ±daki gibi hassas ve kritik operasyonlardan sorumludur:
	1	ğŸ” Ã–deme Ä°ÅŸlemleri: TÃ¼m finansal iÅŸlemlerin gÃ¼venli bir ÅŸekilde yÃ¶netilmesi.
	2	ğŸ“¦ Kargo EntegrasyonlarÄ±: Kargo firmalarÄ±yla olan tÃ¼m iletiÅŸimin gÃ¼venli ve merkezi bir yerden yapÄ±lmasÄ±.
	3	ğŸ‘¨â€ğŸ’¼ YÃ¶netim (Admin) SÃ¼reÃ§leri: Platformun denetim ve mÃ¼dahale gerektiren iÅŸlemlerinin yetkilendirilmiÅŸ bir arayÃ¼zle saÄŸlanmasÄ±.
Cursor'a Kritik Not: GeliÅŸtirme yaparken temel prensip ÅŸu olmalÄ±dÄ±r: Frontend'den gelen hiÃ§bir veriye kÃ¶rÃ¼ kÃ¶rÃ¼ne gÃ¼venme. Frontend'den gelen her tÃ¼rlÃ¼ veri (kullanÄ±cÄ± ID'si, Ã¶denecek tutar, cihaz ID'si vb.) backend'de mutlaka doÄŸrulanmalÄ±, yeniden hesaplanmalÄ± ve yetki kontrollerinden geÃ§irilmelidir. Bu, projenin en temel gÃ¼venlik ilkesidir.

ğŸš€ Ã–ncelikli GeliÅŸtirme PlanÄ±
BelirttiÄŸiniz Ã¼zere, projenin en hÄ±zlÄ± ve gÃ¼venli ÅŸekilde hayata geÃ§mesi iÃ§in geliÅŸtirme fazlarÄ±nÄ± aÅŸaÄŸÄ±daki Ã¶ncelik sÄ±rasÄ±na gÃ¶re dÃ¼zenledim:
Ã–ncelik
Faz
Hedef
Tahmini SÃ¼re
1
Faz 1: Temel AltyapÄ± ve GÃ¼venlik
Projenin iskeletini kurmak, Supabase baÄŸlantÄ±sÄ±nÄ± ve temel kimlik doÄŸrulama (Authentication) mekanizmasÄ±nÄ± oluÅŸturmak.
1 Hafta
2
Faz 2: PAYNET ile Ã–deme Entegrasyonu
En kritik ve ilk canlÄ±ya alÄ±nacak Ã¶zellik. GÃ¼venli Ã¶deme altyapÄ±sÄ±nÄ± ve emanet (escrow) sisteminin temelini oluÅŸturmak. Ãœcret doÄŸrulama mekanizmasÄ± bu fazda hayata geÃ§irilecektir.
2 Hafta
3
Faz 3: Kargo Entegrasyonu
Ã–deme sonrasÄ± kargo kodu oluÅŸturma ve takip sÃ¼reÃ§lerini otomatikleÅŸtirmek. Ä°lk olarak YurtiÃ§i Kargo ile baÅŸlanabilir.
1-2 Hafta
4
Faz 4: Admin Paneli API'leri
YÃ¶netimsel mÃ¼dahaleler (kullanÄ±cÄ± yÃ¶netimi, Ã¶deme takibi, ihtilaf Ã§Ã¶zÃ¼mÃ¼) iÃ§in gerekli temel API endpoint'lerini oluÅŸturmak.
1-2 Hafta
5
DiÄŸer Fazlar
ZamanlanmÄ±ÅŸ gÃ¶revler, bildirimler, kapsamlÄ± test ve production hazÄ±rlÄ±klarÄ±.
2-3 Hafta
Toplam Ã–ncelikli SÃ¼re: ~6-8 hafta

ğŸ› ï¸ Teknoloji YÄ±ÄŸÄ±nÄ± ve Mimari
(Mevcut planÄ±nÄ±zdaki teknoloji yÄ±ÄŸÄ±nÄ± ve mimari tasarÄ±m (proje yapÄ±sÄ±) son derece uygun ve modern standartlardadÄ±r. Bu bÃ¶lÃ¼mlerde herhangi bir deÄŸiÅŸiklik yapmaya gerek yoktur. GeliÅŸtirme sÄ±rasÄ±nda bu yapÄ±ya sadÄ±k kalÄ±nmasÄ± Ã¶nerilir.)

Phase-by-Phase GeliÅŸtirme DetaylarÄ±
Faz 1: Temel AltyapÄ± ve GÃ¼venlik (Hafta 1)
Hedef: NestJS projesinin kurulmasÄ±, konfigÃ¼rasyon yÃ¶netimi ve Supabase ile JWT tabanlÄ± kimlik doÄŸrulamanÄ±n ayaÄŸa kaldÄ±rÄ±lmasÄ±.
GÃ¶revler:
	â€¢	NestJS projesi oluÅŸturma ve temel modÃ¼l yapÄ±sÄ±nÄ±n kurulmasÄ±.@nestjs/config ile environment variables yÃ¶netimi. (.env dosyasÄ±)Supabase client servisinin oluÅŸturulmasÄ± ve SUPABASE_SERVICE_ROLE_KEY ile gÃ¼venli baÄŸlantÄ±.@nestjs/passport ve passport-jwt kullanarak Supabase JWT token'larÄ±nÄ± doÄŸrulayan bir AuthGuard oluÅŸturulmasÄ±.Temel AdminGuard yapÄ±sÄ±nÄ±n oluÅŸturulmasÄ± (kullanÄ±cÄ±nÄ±n rolÃ¼nÃ¼ kontrol edecek).Global ValidationPipe ve ExceptionFilter kurulumu.Swagger/OpenAPI entegrasyonu.
Cursor'a Not: AuthGuard oluÅŸturulurken, Supabase'in public key'ini kullanarak gelen JWT'nin geÃ§erliliÄŸini doÄŸrulamalÄ±sÄ±n. Supabase JWT'leri standart bir yapÄ±ya sahiptir ve bu, gÃ¼venli bir kimlik doÄŸrulama katmanÄ± saÄŸlar. Backend'deki tÃ¼m korumalÄ± endpoint'ler bu AuthGuard ile gÃ¼vence altÄ±na alÄ±nmalÄ±dÄ±r.
Faz 2: PAYNET ile Ã–deme Entegrasyonu ve Escrow YÃ¶netimi (Hafta 2-3)
Hedef: Platformun en kritik Ã¶zelliÄŸi olan Ã¶deme alma ve emanet (escrow) sistemini PAYNET entegrasyonu ile hayata geÃ§irmek.
GÃ¶revler:
	1	Payments ModÃ¼lÃ¼ OluÅŸturma:
	â—¦	payments.controller.ts, payments.service.ts ve payments.module.ts dosyalarÄ±nÄ± oluÅŸtur.POST /api/payments/process endpoint'ini tanÄ±mla. Bu endpoint AuthGuard ile korunmalÄ±dÄ±r.
	2	Ãœcret DoÄŸrulama Servisi (En Kritik GÃ¼venlik AdÄ±mÄ±):
	â—¦	Frontend'den gelen Ã¶deme talebi iÃ§inde (ProcessPaymentDto) deviceId ve totalAmount gibi bilgiler olacak.Backend, deviceId kullanarak devices ve device_models tablolarÄ±ndan cihazÄ±n olmasÄ± gereken ifoundanapple_fee deÄŸerini Ã§ekmelidir.AÅŸaÄŸÄ±daki formÃ¼lÃ¼ backend'de yeniden hesapla:code Code    totalAmount = ifoundanapple_fee (veritabanÄ±ndan alÄ±nacak)
	â—¦	gatewayFee = totalAmount * 0.0343
	â—¦	cargoFee = 250.00
	â—¦	rewardAmount = totalAmount * 0.20
	â—¦	serviceFee = totalAmount - gatewayFee - cargoFee - rewardAmount
	â—¦	  Backend'de hesaplanan totalAmount ile frontend'den gelen tutarÄ± karÅŸÄ±laÅŸtÄ±r. EÄŸer tutarsÄ±zlÄ±k varsa, iÅŸlemi 400 Bad Request veya 422 Unprocessable Entity hatasÄ± ile reddet.
Cursor'a Kritik Not: Bu Ã¼cret doÄŸrulama adÄ±mÄ±, manipÃ¼lasyonu Ã¶nlemek iÃ§in hayati Ã¶nem taÅŸÄ±r. Asla frontend'den gelen fiyata gÃ¼venerek Ã¶deme iÅŸlemi baÅŸlatma. Her zaman veritabanÄ±ndaki "source of truth" (gerÃ§eÄŸin kaynaÄŸÄ±) olan fiyattan yola Ã§Ä±karak hesaplamayÄ± backend'de yap.
	1	PAYNET Entegrasyonu:
	â—¦	PAYNET iÃ§in Ã¶zel bir PaynetProvider servisi oluÅŸtur.PAYNET API'sine istek atmak iÃ§in @nestjs/axios kullan. API key ve secret key gibi hassas bilgileri .env dosyasÄ±ndan al.Ã–deme iÅŸlemini baÅŸlatmak iÃ§in PAYNET'in ilgili endpoint'ine istek at.Ã–deme baÅŸarÄ±lÄ± olduÄŸunda veritabanÄ± kayÄ±tlarÄ±nÄ± oluÅŸtur (payments, escrow_accounts, financial_transactions). devices tablosunun status alanÄ±nÄ± payment_completed olarak gÃ¼ncelle.
	2	Webhook YÃ¶netimi:
	â—¦	POST /api/webhooks/paynet-callback endpoint'ini oluÅŸtur.Gelen webhook isteÄŸinin gerÃ§ekten PAYNET'ten geldiÄŸini doÄŸrulamak iÃ§in signature verification (imza doÄŸrulama) mekanizmasÄ±nÄ± uygula. Bu adÄ±m atlanamaz.Idempotency kontrolÃ¼ ekle (aynÄ± webhook'un birden fazla iÅŸlenmesini Ã¶nlemek iÃ§in).
Faz 3: Kargo Entegrasyonu (Hafta 4-5)
Hedef: Ã–demesi tamamlanmÄ±ÅŸ iÅŸlemler iÃ§in kargo kodu Ã¼retmek ve gÃ¶nderi sÃ¼recini yÃ¶netmek.
GÃ¶revler:
	â€¢	CargoModule ve ilgili servisleri/controller'larÄ± oluÅŸtur.YurtiÃ§i Kargo API'si iÃ§in bir YurticiProvider oluÅŸtur.Ã–deme baÅŸarÄ±yla tamamlandÄ±ÄŸÄ±nda (payment_completed durumunda) tetiklenecek bir servis metodu yaz. Bu metod, YurticiProvider'Ä± Ã§aÄŸÄ±rarak gÃ¶nderi oluÅŸturma iÅŸlemini baÅŸlatÄ±r.GÃ¶nderi oluÅŸturma API'sine istek atarken, PROCESS_FLOW.md dosyasÄ±nda belirtildiÄŸi gibi kullanÄ±cÄ±larÄ±n kiÅŸisel bilgileri (adres vb.) gizli kalacak ÅŸekilde anonim ID'ler (FND-XXX, OWN-XXX) kullan.Kargo API'sinden dÃ¶nen teslim kodu (code) ve takip numarasÄ±nÄ± (tracking_number) alarak cargo_shipments tablosuna kaydet.
Cursor'a Not: Kargo teslim kodu sistem tarafÄ±ndan Ã¼retilmez. Bu kod, kargo firmasÄ±nÄ±n API'sinden gelen yanÄ±ttan alÄ±nÄ±r. Bulan kullanÄ±cÄ±nÄ±n arayÃ¼zde bir form doldurmasÄ±na gerek yoktur. Sadece Ã¶deme tamamlandÄ±ktan sonra kendisine gÃ¶sterilen bu hazÄ±r kod ile kargo ÅŸubesine gitmesi yeterlidir. Bu akÄ±ÅŸ, kullanÄ±cÄ± deneyimini basitleÅŸtirir ve hata payÄ±nÄ± azaltÄ±r.
	â€¢	Kargo durumu gÃ¼ncellemeleri iÃ§in POST /api/webhooks/cargo/yurtici gibi bir webhook endpoint'i oluÅŸtur ve imza doÄŸrulamasÄ±nÄ± uygula.
Faz 4: Admin Paneli API'leri (Hafta 6-7)
Hedef: Platformu yÃ¶netmek iÃ§in temel CRUD ve yÃ¶netimsel iÅŸlemleri saÄŸlayan API'leri oluÅŸturmak.
GÃ¶revler:
	â€¢	AdminModule oluÅŸtur ve tÃ¼m endpoint'leri AdminGuard ile koru.KullanÄ±cÄ± YÃ¶netimi: KullanÄ±cÄ± listeleme, durumunu deÄŸiÅŸtirme (GET /api/admin/users, PATCH /api/admin/users/:id/status).Ã–deme YÃ¶netimi: Ã–deme iÅŸlemlerini listeleme, detaylarÄ±nÄ± gÃ¶rme ve manuel iade (POST /api/admin/payments/:id/refund) veya manuel escrow serbest bÄ±rakma (POST /api/admin/escrow/release) gibi kritik iÅŸlemleri gerÃ§ekleÅŸtirme.Ä°htilaf YÃ¶netimi: DISPUTED durumundaki iÅŸlemleri yÃ¶netmek ve Ã§Ã¶zÃ¼me kavuÅŸturmak iÃ§in endpoint'ler (GET /api/admin/disputes, POST /api/admin/disputes/:id/resolve).
Cursor'a Not: PROCESS_FLOW.md dosyasÄ±nda cihaz eÅŸleÅŸtirme ve durum gÃ¼ncellemelerinin frontend'de yapÄ±ldÄ±ÄŸÄ± belirtiliyor. Bu, baÅŸlangÄ±Ã§ iÃ§in yeterli olabilir. Ancak admin panelinde, bir iÅŸlemin takÄ±lmasÄ± veya yanlÄ±ÅŸ gitmesi durumunda admin'in cihaz durumunu manuel olarak gÃ¼ncelleyebileceÄŸi (PATCH /api/admin/devices/:id/status) bir endpoint'in olmasÄ±, ileride yaÅŸanabilecek sorunlarÄ± Ã§Ã¶zmek iÃ§in Ã§ok faydalÄ± olacaktÄ±r. Bu endpoint, service_role_key kullanarak RLS kurallarÄ±nÄ± atlayarak Supabase'e yazmalÄ±dÄ±r.

âœ… SonuÃ§ ve Ã–zet
Bu geliÅŸtirilmiÅŸ yol haritasÄ±, projenizin en kritik Ã¶zelliklerine odaklanarak sizi adÄ±m adÄ±m hedefe ulaÅŸtÄ±racaktÄ±r.
	1	GÃ¼venlik Her Åeydir: Backend'in ana amacÄ± budur. Her adÄ±mda bu ilkeyi gÃ¶zetin.
	2	Ã–nceliklendirme: Ä°lk olarak PAYNET Ã¶deme akÄ±ÅŸÄ±nÄ± tamamlayÄ±p test ederek projenin en riskli kÄ±smÄ±nÄ± halledin.
	3	Net Sorumluluklar: Backend, finans ve harici API entegrasyonlarÄ±nÄ±n merkezidir. Frontend ise kullanÄ±cÄ± deneyimi ve Supabase ile doÄŸrudan (ama RLS korumalÄ±) veri alÄ±ÅŸveriÅŸinden sorumludur.
	4	Cursor NotlarÄ±: Kodlama sÄ±rasÄ±nda eklediÄŸim Cursor'a Not bÃ¶lÃ¼mleri, yapay zekanÄ±n doÄŸru ve gÃ¼venli kod Ã¼retmesine yardÄ±mcÄ± olacak kritik hatÄ±rlatmalardÄ±r.